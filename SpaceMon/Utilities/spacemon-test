### Test suite for SpaceMon client tool 
# Tests 4,5,6 may not be working with a fake test node, as of spacemon-client version 1.0.1 


### Setting the defaults and locations
# Assuming github structure: spacemon is located in the same directory as spacemon-test. 
spacemon=`echo $0 | sed 's/-test$//'`

testdir=/tmp/spacemon-tests.`date +%s`
mkdir $testdir
testnode=T2_Test_Buffer
testnode=T3_US_FNALLPC

### Execute the tests
# Each test prints output on the screen and redirects to the file in /tmp dir.
# Redefine $testdir above if you do not want to pollute the /tmp, or prefer the log files 
# stay persistent after the system reboot/upgrade. 

echo -e     "\n******* test1: Executing $spacemon " 
$spacemon  2>&1 | tee $testdir/test1.log

echo -e     "\n******* test2: Executing $spacemon -h " 
$spacemon -h  2>&1 | tee $testdir/test2.log

echo -e     "\n******* test3: Executing $spacemon --version  "
$spacemon --version  2>&1 | tee $testdir/test3.log

echo -e     "\n******* Testing TXT format input file " 

dummydump=$testdir/example.txt
touch $dummydump

echo -e     "\n******* Created file $dummydump "

echo "/store/CSA07/2007/10/30/CSA07-CSA07JetMET-Tier0-A2-Stew/0046/CAB1B2FD-1288-DC11-8547-003048562842.root|3719230435|1331650563.42|4e18657" >>  $dummydump
echo "/store/CSA07/2007/10/30/CSA07-CSA07JetMET-Tier0-A2-Stew/0047/0E30D3EB-8288-DC11-B153-00304855D49C.root|4168290793|1331650576.56|e45742b2" >>  $dummydump

echo -e     "\n******* Test4: Executing $spacemon --node $testnode --dump $dummydump "
$spacemon --node $testnode --dump $dummydump 2>&1 | tee $testdir/test4.log

echo -e     "\n******* Testing XML format and compressed input file" 

dummydump=$testdir/example.xml
touch $dummydump

echo -e     "\n******* Created file $dummydump "
echo '<?xml version="1.0" encoding="iso-8859-1"?><dump recorded="2012-02-27T12:33:23.902495"><for>vo:cms</for>' >> $dummydump
echo '<entry-set>' >> $dummydump
echo '<entry name="/dpm/in2p3.fr/home/cms/trivcat/store/mc/JobRobot/RelValProdTTbar/GEN-SIM-DIGI-RECO/MC_3XY_V24_JobRobot-v1/0000/001606D5-FC2B-DF11-9FD5-0030487C6A66.root"><size>1139273384</size><ctime>1296671817</ctime><checksum>AD:ca793d51</checksum></entry>' >> $dummydump
echo '<entry name="/dpm/in2p3.fr/home/cms/trivcat/store/mc/JobRobot/RelValProdTTbar/GEN-SIM-DIGI-RECO/MC_3XY_V24_JobRobot-v1/0000/0068DD7E-3D2C-DF11-AE3E-0030487C778E.root"><size>1062056867</size><ctime>1296707321</ctime><checksum>AD:9fa5feec</checksum></entry>' >> $dummydump
echo '</entry-set></dump>' >> $dummydump

gzip $dummydump
# New chimera-dump syntax for dCache 2.15+ Aachen example: 

dummydump2=$testdir/example2.xml
(
cat <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<cat xmlns="http://www.dcache.org/PROPOSED/2008/01/Cat"
        xmlns:dCache="http://www.dcache.org/PROPOSED/2008/01/Cat/dCache">
<dump recorded="2017-04-01T12:02:04Z">
<entry-set>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/joe/crab_Wprime_Data/Tau/WPrimeToTaus_data/161103_135541/0000/hist_analysis_413.root"><size>2092237</size><dCache:atime>1478192527.0</dCache:atime><checksum>56dfd4a9</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith1/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith2/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith3/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith4/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith5/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith6/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith7/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith8/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith9/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
<entry name="/pnfs/physik.rwth-aachen.de/cms/store/user/smith10/ttbb_v2a/meta/mu_syst_jerDown_tuple/B/task_report_Bndq4aypk5KR5A.json"><size>3142</size><dCache:atime>1456014607.0</dCache:atime><checksum>070bcb8c</checksum></entry>
</entry-set>
EOF
) > $dummydump2
bzip2 $dummydump2

echo -e     "\n******* Test5: Executing $spacemon --node $testnode -dump ${dummydump}.gz "
$spacemon --node $testnode --dump $dummydump.gz 2>&1  | tee $testdir/test5.log

echo -e     "\n******* Test6: Executing $spacemon --node $testnode -dump ${dummydump2}.bz2 "
$spacemon --node $testnode --dump ${dummydump2}.bz2 2>&1  | tee $testdir/test6.log

#echo -e     "\n******* Test7: Executing $spacemon --node $testnode --dump $dummydump.gz --upload " 
#$spacemon --node $testnode --dump $dummydump.gz --upload 2>&1  | tee $testdir/test7.log

echo -e     "\n******* Tests OUTPUT can be found in $testdir "
